# ADHDGoFly 浏览器插件开发规划

## 项目目标
开发一个专注于网页文本词性高亮的浏览器扩展，通过智能分词和词性标注提升阅读体验。

## 核心功能规划

### 1. 多语言词典系统 (优先级: 高)
**功能描述**: 支持多语言、多词典的词性标注系统

**词典管理**:
- **默认词典**: 内置基础中英文词典
- **官方词典**: 通过下载按钮获取最新官方词典
- **用户词典**: 支持用户自定义词典导入
- **词典格式**: 标准格式包含 n(名词)、v(动词)、a(形容词) 三种基础词性

**实现方案**:
```javascript
// 词典结构示例
{
  "word": {
    "pos": ["n", "v"],  // 词性数组
    "freq": 1000        // 词频（可选）
  }
}
```

### 2. 智能分词与词性标注 (优先级: 高)
**功能描述**: 根据语言特点进行分词和词性标注

**分词策略**:
- **中文/日语**: 双向最大匹配算法 + 词典比对
- **英文等**: 空格分词 + 词性标注
- **词典优化**: 预处理词典为 Trie 树或哈希表结构

**实现方案**:
```javascript
class Segmenter {
  // 双向最大匹配算法
  bidirectionalMaxMatch(text, dictionary) {
    const forward = this.forwardMaxMatch(text, dictionary);
    const backward = this.backwardMaxMatch(text, dictionary);
    return this.selectBestResult(forward, backward);
  }
  
  // 词性标注
  posTagging(segments, dictionary) {
    return segments.map(word => ({
      text: word,
      pos: dictionary[word]?.pos || ['unknown']
    }));
  }
}
```

### 3. 网页结构化高亮处理 (优先级: 高)
**功能描述**: 智能识别网页结构，优先处理重要内容

**处理优先级**:
1. **标题区域**: h1-h6 标签
2. **正文内容**: article, main, .content 等
3. **段落处理**: 流式处理，逐段落高亮
4. **兜底策略**: 结构混乱时分区域依次处理

**实现方案**:
```javascript
class PageProcessor {
  async processPage() {
    // 1. 识别页面结构
    const structure = this.analyzePageStructure();
    
    // 2. 按优先级处理
    await this.processTitles(structure.titles);
    await this.processArticles(structure.articles);
    await this.processParagraphs(structure.paragraphs);
  }
  
  // 流式段落处理
  async processParagraphs(paragraphs) {
    for (const paragraph of paragraphs) {
      await this.highlightParagraph(paragraph);
      await this.sleep(10); // 避免阻塞
    }
  }
}
```

### 4. 视觉样式控制系统 (优先级: 中)
**功能描述**: 提供丰富的视觉定制选项

**样式控制**:
- **颜色方案**: 多套预设配色 + 自定义颜色
- **字体设置**: 字号、字间距、行间距调节
- **字体替换**: 如浏览器允许，支持字体更换

**配色方案示例**:
```css
/* 默认方案 */
.pos-noun { color: #0066cc; background: rgba(0,102,204,0.1); }
.pos-verb { color: #cc0000; background: rgba(204,0,0,0.1); }
.pos-adj { color: #009933; background: rgba(0,153,51,0.1); }

/* 护眼方案 */
.pos-noun { color: #2d5aa0; background: rgba(45,90,160,0.08); }
.pos-verb { color: #a0522d; background: rgba(160,82,45,0.08); }
.pos-adj { color: #228b22; background: rgba(34,139,34,0.08); }
```

## 技术架构

### 文件结构
```
adhd-extension/
├── manifest.json
├── background/
│   └── service-worker.js
├── content/
│   ├── content.js
│   ├── segmenter.js
│   ├── highlighter.js
│   ├── page-processor.js
│   └── content.css
├── popup/
│   ├── popup.html
│   ├── popup.js
│   └── popup.css
├── options/
│   ├── options.html
│   ├── options.js
│   └── style-controls.js
├── dictionaries/
│   ├── default/
│   │   ├── zh-basic.json
│   │   └── en-basic.json
│   ├── official/
│   └── user/
├── libs/
│   ├── trie.js
│   ├── dictionary-manager.js
│   └── language-detector.js
└── assets/
    ├── icons/
    └── themes/
```

### 核心模块设计

#### 1. 词典管理模块 (`libs/dictionary-manager.js`)
```javascript
class DictionaryManager {
  constructor() {
    this.dictionaries = new Map();
    this.trieCache = new Map();
  }
  
  async loadDictionary(lang, type = 'default') {
    // 加载并预处理词典为 Trie 树
    const dict = await this.fetchDictionary(lang, type);
    this.trieCache.set(lang, this.buildTrie(dict));
  }
  
  lookup(word, lang) {
    const trie = this.trieCache.get(lang);
    return trie ? trie.search(word) : null;
  }
}
```

#### 2. 分词器模块 (`content/segmenter.js`)
```javascript
class Segmenter {
  constructor(dictionaryManager) {
    this.dictManager = dictionaryManager;
  }
  
  segment(text, lang) {
    if (['zh', 'ja'].includes(lang)) {
      return this.bidirectionalMaxMatch(text, lang);
    } else {
      return this.spaceBasedSegment(text, lang);
    }
  }
  
  bidirectionalMaxMatch(text, lang) {
    // 双向最大匹配实现
    const maxLen = 10; // 最大词长
    const forward = this.forwardMatch(text, lang, maxLen);
    const backward = this.backwardMatch(text, lang, maxLen);
    return this.selectBest(forward, backward);
  }
}
```

#### 3. 页面处理器 (`content/page-processor.js`)
```javascript
class PageProcessor {
  constructor() {
    this.segmenter = new Segmenter();
    this.highlighter = new Highlighter();
  }
  
  analyzePageStructure() {
    return {
      titles: document.querySelectorAll('h1,h2,h3,h4,h5,h6'),
      articles: document.querySelectorAll('article,main,[class*="content"]'),
      paragraphs: document.querySelectorAll('p,div[class*="text"]')
    };
  }
  
  async processStreamly(elements) {
    for (const element of elements) {
      await this.processElement(element);
      await new Promise(resolve => setTimeout(resolve, 5));
    }
  }
}
```

#### 4. 高亮渲染器 (`content/highlighter.js`)
```javascript
class Highlighter {
  applyHighlight(element, segments) {
    const html = segments.map(seg => {
      const className = `pos-${seg.pos[0]}`;
      return `<span class="${className}">${seg.text}</span>`;
    }).join('');
    
    element.innerHTML = html;
  }
  
  updateTheme(themeName) {
    document.documentElement.setAttribute('data-adhd-theme', themeName);
  }
}
```

## 开发阶段规划

### 阶段一: 基础架构 (1-2周)
- [ ] 创建扩展基础结构和 Manifest V3 配置
- [ ] 实现词典管理系统和 Trie 树结构
- [ ] 建立多语言检测机制
- [ ] 基础 Content Script 注入框架

### 阶段二: 分词与标注 (2-3周)
- [ ] 实现双向最大匹配分词算法
- [ ] 开发词性标注系统
- [ ] 集成默认词典（中英文基础词典）
- [ ] 语言检测和分词测试

### 阶段三: 页面处理与高亮 (2-3周)
- [ ] 页面结构分析和内容提取
- [ ] 流式段落处理逻辑
- [ ] 高亮渲染系统
- [ ] 多种颜色方案实现

### 阶段四: 样式控制与优化 (1-2周)
- [ ] 设置面板开发（字体、间距、颜色）
- [ ] 性能优化和兼容性测试
- [ ] 官方词典下载功能
- [ ] 用户词典导入功能

## 技术选型

### 前端技术
- **原生 JavaScript**: 减少体积，提高性能
- **CSS3**: 现代样式和动画
- **Web Components**: 组件化开发（可选）

### 第三方库
- **原生 JavaScript**: 主要实现语言，避免过多依赖
- **Trie 数据结构**: 高效词典查询
- **Web Workers**: 大文本处理（可选）

### API 集成
- **Chrome Extension APIs**: 存储、通信等核心功能
- **官方词典 API**: 词典下载和更新服务

## 关键注意事项

### 1. 性能考虑
- **避免阻塞主线程**: 大量文本处理使用 Web Workers
- **内存管理**: 及时清理 DOM 监听器和缓存
- **懒加载**: 按需加载词典和 AI 功能

### 2. 兼容性问题
- **网站 CSP 策略**: 某些网站可能阻止脚本注入
- **DOM 结构差异**: 不同网站的 DOM 结构处理
- **样式冲突**: 避免与网站原有样式冲突

### 3. 用户体验
- **非侵入式设计**: 不影响原网页功能
- **可控性**: 用户可以随时开关功能
- **视觉反馈**: 清晰的功能状态提示

### 4. 数据安全
- **本地存储**: 敏感数据不上传到服务器
- **API 密钥**: 安全存储用户的 API 配置
- **权限最小化**: 只申请必要的扩展权限

### 5. 发布考虑
- **商店审核**: 遵循 Chrome Web Store 政策
- **隐私政策**: 明确数据使用说明
- **用户反馈**: 建立反馈收集机制

## 最小可行产品 (MVP)

### 核心功能
1. 基础中英文词典和词性高亮
2. 页面结构识别和流式处理
3. 基础样式控制（颜色方案、字体大小）
4. 开关控制和基础设置

### 成功指标
- 支持主流网站的文本高亮
- 分词准确率 > 85%
- 页面处理响应时间 < 1s
- 不影响原网页功能和性能

## 推荐方案 - 升级功能

### 高级交互功能
1. **快捷词典查询**: 双击/悬停查词
2. **智能翻译**: 选中文本翻译
3. **AI 文本解读**: 
   - AI 解读全文功能
   - AI 解读选中文本
   - 智能摘要生成

### 语音功能
1. **语音朗读**: TTS 朗读网页内容
2. **语音输入**: STT 语音转文字输入

### 高级词典功能
1. **专业词典**: 医学、法律、技术等领域词典
2. **词典同步**: 云端词典同步
3. **学习记录**: 查词历史和生词本

### 个性化功能
1. **阅读习惯分析**: 基于用户行为优化
2. **自适应高亮**: 根据阅读偏好调整
3. **多设备同步**: 设置和数据跨设备同步

*注: 升级功能将在 MVP 稳定后逐步开发，具体优先级根据用户反馈确定。*

---

*注: 此规划为初版方案，具体实现细节需根据实际开发过程中的技术验证和用户反馈进行调整。*