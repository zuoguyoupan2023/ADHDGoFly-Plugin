# 插件发布与词典管理方案

## 1. Chrome插件发布与更新机制

### 1.1 Chrome官方渠道发布

#### 发布流程
1. **开发者账号注册**
   - 注册Chrome Web Store开发者账号
   - 支付一次性注册费用（$5）
   - 完成身份验证

2. **插件提交**
   - 准备插件包（zip格式）
   - 填写插件详细信息（名称、描述、截图等）
   - 设置权限说明
   - 提交审核（通常1-3个工作日）

3. **审核通过后发布**
   - 插件在Chrome Web Store上线
   - 用户可以搜索并安装

#### 官方渠道更新机制
- **自动更新**：Chrome浏览器会自动检查并更新已安装的插件
- **更新频率**：通常在插件发布新版本后24-48小时内推送给用户
- **用户通知**：
  - Chrome会在后台静默更新
  - 重要更新可通过插件图标显示更新提示
  - 可在插件弹窗中显示更新日志

#### 版本管理策略
```json
{
  "manifest_version": 3,
  "version": "1.2.3",
  "version_name": "1.2.3 - 新增词典管理功能"
}
```

### 1.2 自主分发更新机制

#### 分发方式
1. **GitHub Releases**
   - 在GitHub仓库发布版本
   - 提供crx文件下载
   - 用户手动安装

2. **官方网站分发**
   - 建立官方下载页面
   - 提供安装教程
   - 维护版本历史

#### 更新通知机制

**方案一：内置更新检查**
```javascript
// background.js 中实现
class UpdateChecker {
  constructor() {
    this.updateUrl = 'https://api.github.com/repos/username/repo/releases/latest';
    this.checkInterval = 24 * 60 * 60 * 1000; // 24小时检查一次
  }

  async checkForUpdates() {
    try {
      const response = await fetch(this.updateUrl);
      const latestRelease = await response.json();
      const latestVersion = latestRelease.tag_name;
      const currentVersion = chrome.runtime.getManifest().version;
      
      if (this.isNewerVersion(latestVersion, currentVersion)) {
        this.notifyUpdate(latestRelease);
      }
    } catch (error) {
      console.error('检查更新失败:', error);
    }
  }

  notifyUpdate(release) {
    // 显示更新通知
    chrome.notifications.create({
      type: 'basic',
      iconUrl: 'icon.png',
      title: 'ADHD阅读助手有新版本',
      message: `发现新版本 ${release.tag_name}，点击查看更新内容`
    });
    
    // 在插件弹窗中显示更新提示
    chrome.storage.local.set({
      updateAvailable: {
        version: release.tag_name,
        downloadUrl: release.assets[0].browser_download_url,
        releaseNotes: release.body
      }
    });
  }
}
```

**方案二：邮件订阅通知**
- 建立邮件订阅系统
- 用户可选择订阅更新通知
- 发布新版本时发送邮件通知

**方案三：社交媒体通知**
- 通过微博、Twitter等平台发布更新信息
- 建立用户群组（QQ群、微信群）
- 定期发布更新公告

## 2. 词典管理与更新方案

### 2.1 词典架构设计

#### 当前词典结构
```
dictionaries/
├── ZH_word.json    # 中文词典
├── EN_word.json    # 英文词典
├── JA_word.json    # 日文词典
├── FR_word.json    # 法文词典
├── ES_word.json    # 西班牙文词典
└── RU_word.json    # 俄文词典
```

#### 词典版本管理
```json
{
  "version": "1.0.0",
  "lastUpdated": "2024-01-15T10:30:00Z",
  "totalWords": 50000,
  "categories": {
    "noun": 25000,
    "verb": 15000,
    "adjective": 10000
  },
  "words": {
    "apple": {
      "pos": "n",
      "frequency": 0.8,
      "difficulty": 1
    }
  }
}
```

### 2.2 词典更新机制

#### 方案一：增量更新系统

**1. 词典版本服务器**
```javascript
// 词典版本检查API
const DICTIONARY_API = 'https://api.adhdhelper.com/dictionaries';

class DictionaryManager {
  async checkDictionaryUpdates() {
    const localVersions = await this.getLocalDictionaryVersions();
    const response = await fetch(`${DICTIONARY_API}/versions`);
    const serverVersions = await response.json();
    
    const updatesNeeded = [];
    
    for (const [lang, serverVersion] of Object.entries(serverVersions)) {
      const localVersion = localVersions[lang] || '0.0.0';
      if (this.isNewerVersion(serverVersion.version, localVersion)) {
        updatesNeeded.push({
          language: lang,
          currentVersion: localVersion,
          newVersion: serverVersion.version,
          updateSize: serverVersion.size,
          updateType: serverVersion.updateType // 'full' | 'incremental'
        });
      }
    }
    
    return updatesNeeded;
  }

  async downloadDictionaryUpdate(language, updateType) {
    const url = `${DICTIONARY_API}/${language}/${updateType}`;
    const response = await fetch(url);
    const updateData = await response.json();
    
    if (updateType === 'incremental') {
      await this.applyIncrementalUpdate(language, updateData);
    } else {
      await this.replaceFullDictionary(language, updateData);
    }
  }
}
```

**2. 增量更新格式**
```json
{
  "version": "1.1.0",
  "previousVersion": "1.0.0",
  "updateType": "incremental",
  "changes": {
    "added": {
      "smartphone": {
        "pos": "n",
        "frequency": 0.9,
        "difficulty": 2
      }
    },
    "modified": {
      "computer": {
        "frequency": 0.95
      }
    },
    "removed": ["obsoleteword1", "obsoleteword2"]
  }
}
```

#### 方案二：云端词典服务

**1. 实时词典API**
```javascript
class CloudDictionaryService {
  constructor() {
    this.apiBase = 'https://api.adhdhelper.com';
    this.cache = new Map();
    this.cacheExpiry = 24 * 60 * 60 * 1000; // 24小时缓存
  }

  async getWordInfo(word, language = 'auto') {
    const cacheKey = `${word}_${language}`;
    const cached = this.cache.get(cacheKey);
    
    if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
      return cached.data;
    }

    try {
      const response = await fetch(`${this.apiBase}/word/${word}?lang=${language}`);
      const wordInfo = await response.json();
      
      this.cache.set(cacheKey, {
        data: wordInfo,
        timestamp: Date.now()
      });
      
      return wordInfo;
    } catch (error) {
      // 降级到本地词典
      return this.getLocalWordInfo(word, language);
    }
  }
}
```

### 2.3 用户通知机制

#### 词典更新通知UI

**1. 弹窗通知组件**
```html
<!-- 词典更新通知弹窗 -->
<div id="dictionary-update-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>📚 词典更新可用</h3>
      <button class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="update-info">
        <p>发现 <strong id="update-count">3</strong> 个词典有更新：</p>
        <ul id="update-list">
          <li>
            <span class="lang-flag">🇨🇳</span>
            中文词典 v1.2.0 → v1.3.0
            <span class="update-size">(+2,500词)</span>
          </li>
        </ul>
      </div>
      <div class="update-benefits">
        <h4>更新内容：</h4>
        <ul>
          <li>新增科技类词汇2,500个</li>
          <li>优化词频数据准确性</li>
          <li>修复部分词性标注错误</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer">
      <button id="update-now-btn" class="btn-primary">立即更新</button>
      <button id="update-later-btn" class="btn-secondary">稍后提醒</button>
      <button id="skip-update-btn" class="btn-text">跳过此版本</button>
    </div>
  </div>
</div>
```

**2. 更新进度显示**
```javascript
class DictionaryUpdateUI {
  showUpdateProgress(updates) {
    const progressModal = document.getElementById('update-progress-modal');
    const progressBar = document.getElementById('update-progress-bar');
    const statusText = document.getElementById('update-status-text');
    
    progressModal.style.display = 'block';
    
    let completed = 0;
    const total = updates.length;
    
    updates.forEach(async (update, index) => {
      statusText.textContent = `正在更新${update.language}词典...`;
      
      await this.downloadDictionaryUpdate(update.language);
      
      completed++;
      const progress = (completed / total) * 100;
      progressBar.style.width = `${progress}%`;
      
      if (completed === total) {
        statusText.textContent = '更新完成！';
        setTimeout(() => {
          progressModal.style.display = 'none';
          this.showUpdateSuccess();
        }, 1000);
      }
    });
  }

  showUpdateSuccess() {
    // 显示更新成功通知
    chrome.notifications.create({
      type: 'basic',
      iconUrl: 'icon.png',
      title: '词典更新完成',
      message: '所有词典已更新到最新版本，享受更准确的词汇识别！'
    });
  }
}
```

#### 通知策略

**1. 自动检查时机**
- 插件启动时检查
- 每周定时检查
- 用户手动触发检查

**2. 通知频率控制**
```javascript
class NotificationManager {
  constructor() {
    this.notificationCooldown = 7 * 24 * 60 * 60 * 1000; // 7天冷却期
  }

  async shouldShowUpdateNotification(updateInfo) {
    const lastNotification = await chrome.storage.local.get('lastUpdateNotification');
    const now = Date.now();
    
    // 重要更新立即通知
    if (updateInfo.priority === 'high') {
      return true;
    }
    
    // 普通更新遵循冷却期
    if (!lastNotification.lastUpdateNotification || 
        now - lastNotification.lastUpdateNotification > this.notificationCooldown) {
      await chrome.storage.local.set({ lastUpdateNotification: now });
      return true;
    }
    
    return false;
  }
}
```

### 2.4 词典管理界面

#### 词典状态面板
```html
<div class="dictionary-panel">
  <h3>📚 词典管理</h3>
  
  <div class="dictionary-list">
    <div class="dictionary-item" data-lang="zh">
      <div class="dict-info">
        <span class="lang-flag">🇨🇳</span>
        <div class="dict-details">
          <h4>中文词典</h4>
          <p>版本 v1.3.0 | 52,000词 | 最后更新：2024-01-15</p>
        </div>
      </div>
      <div class="dict-actions">
        <button class="btn-small" onclick="checkDictionaryUpdate('zh')">检查更新</button>
        <button class="btn-small" onclick="exportDictionary('zh')">导出</button>
      </div>
    </div>
  </div>
  
  <div class="dictionary-stats">
    <div class="stat-item">
      <span class="stat-label">总词汇量</span>
      <span class="stat-value">156,000</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">上次更新</span>
      <span class="stat-value">3天前</span>
    </div>
  </div>
</div>
```

## 3. 实施建议

### 3.1 发布策略
1. **初期**：Chrome官方渠道发布，建立用户基础
2. **成长期**：同时维护官方渠道和自主分发
3. **成熟期**：根据用户反馈优化更新机制

### 3.2 词典更新策略
1. **渐进式实施**：先实现基础更新检查，再添加增量更新
2. **用户体验优先**：确保更新过程不影响正常使用
3. **数据安全**：实现词典备份和恢复机制

### 3.3 监控与反馈
1. **更新成功率监控**
2. **用户满意度调查**
3. **错误日志收集**
4. **性能影响评估**

## 4. 技术实现要点

### 4.1 版本比较算法
```javascript
function compareVersions(version1, version2) {
  const v1parts = version1.split('.').map(Number);
  const v2parts = version2.split('.').map(Number);
  
  for (let i = 0; i < Math.max(v1parts.length, v2parts.length); i++) {
    const v1part = v1parts[i] || 0;
    const v2part = v2parts[i] || 0;
    
    if (v1part > v2part) return 1;
    if (v1part < v2part) return -1;
  }
  
  return 0;
}
```

### 4.2 错误处理机制
```javascript
class UpdateErrorHandler {
  async handleUpdateError(error, context) {
    console.error('更新失败:', error);
    
    // 记录错误日志
    await this.logError(error, context);
    
    // 显示用户友好的错误信息
    this.showErrorNotification(error.type);
    
    // 尝试回滚或降级处理
    if (context.type === 'dictionary') {
      await this.rollbackDictionary(context.language);
    }
  }
}
```

### 4.3 性能优化
1. **懒加载**：按需加载词典数据
2. **压缩传输**：使用gzip压缩更新包
3. **断点续传**：支持大文件分块下载
4. **缓存策略**：合理设置缓存过期时间

---

*本文档将根据实际开发进展和用户反馈持续更新完善。*